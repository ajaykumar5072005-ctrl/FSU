<!DOCTYPE html>
<html>
<head>
<title>Student Profile</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Arial;background:#f4f6f8}
.box{
  max-width:500px;
  margin:40px auto;
  background:#fff;
  padding:20px;
  border-radius:8px;
}
button{
  background:#d32f2f;
  color:#fff;
  border:none;
  padding:10px;
  width:100%;
}
</style>
</head>

<body>

<div class="box">
  <h2>My Details</h2>
  <p><b>Admission No:</b> <span id="admissionNo"></span></p>
  <p><b>Name:</b> <span id="name"></span></p>
  <p><b>Father:</b> <span id="father"></span></p>
  <p><b>Mother:</b> <span id="mother"></span></p>
  <p><b>Email:</b> <span id="email"></span></p>
  <p><b>Phone:</b> <span id="phone"></span></p>
  <p><b>Course :</b> <span id="p_course"></span></p>
<p><b>Branch :</b> <span id="p_branch"></span></p>

  <p><b>Year / Semester:</b> <span id="study"></span></p>
  <p><b>Fees Mode:</b> <span id="payment"></span></p>
  
  <hr>

  <h3>Syllabus</h3>
  <button onclick="openSyllabus()">View Syllabus PDF</button>

<h3>Payment History</h3>
<ul id="paymentHistory"></ul>

<h3 id="payEmiHeading" style="display:none;">Pay Due EMI</h3>


<div id="emiPayBox" style="display:none;">
  <select id="emiSelect" style="display:none;margin-bottom:10px;"></select>
  <input type="text" id="emiUpi" placeholder="Enter UPI ID">
  <div id="emiPayErr" style="color:red;font-size:13px"></div>
  <button onclick="payDueEmi()">Pay EMI Online</button>
</div>

<button id="nextAdmissionBtn" onclick="applyNextAdmission()">
  Apply for Next Year / Semester
</button>

<hr>
  <button onclick="logout()">Logout</button>
</div>

<script>
if(localStorage.getItem("loggedIn") !== "yes"){
  window.location.href = "login.html";
}

const data = JSON.parse(localStorage.getItem("currentStudent"));

if(data){
  document.getElementById("admissionNo").innerText = data.admissionNo;
  document.getElementById("name").innerText = data.name;
  document.getElementById("father").innerText = data.father;
  document.getElementById("mother").innerText = data.mother;

  document.getElementById("email").innerText = data.email;
  document.getElementById("phone").innerText = data.phone;

 document.getElementById("p_course").innerText = data.course || "-";
document.getElementById("p_branch").innerText = data.branch || "-";

  document.getElementById("study").innerText =
    data.studyType === "year"
      ? data.year + " Year"
      : data.semester + " Semester";

  
  document.getElementById("payment").innerText =
    data.paymentMode === "emi" ? "EMI" : "FULL";
}



//syllabus PDF open button
function openSyllabus(){
  const student = JSON.parse(localStorage.getItem("currentStudent"));
  if(student && student.syllabusPDF){
    window.open(student.syllabusPDF, "_blank");
  }else{
    alert("Syllabus not available");
  }
}
const list = document.getElementById("paymentHistory");
list.innerHTML = "";

if(data.paymentHistory && data.paymentHistory.length > 0){

  // ðŸ”¹ TOTAL FEES CALCULATION
  let totalFees = 0;

  if(data.paymentMode === "emi"){
    totalFees = data.paymentHistory.reduce((sum,p)=>sum + p.amount, 0);
  }else{
    totalFees = data.paymentHistory[0].amount;
  }

  data.paymentHistory.forEach(p=>{
    const li = document.createElement("li");
    li.style.marginBottom = "12px";

    if(p.type === "EMI"){
      li.innerHTML = `
        <b>EMI ${p.emiNo}</b><br>
        Total Fees: â‚¹${totalFees}<br>
        EMI Amount: â‚¹${p.amount}<br>
        Status: <b style="color:${p.status==="PAID"?"green":"red"}">${p.status}</b><br>
        Date: ${p.date || "-"}
      `;
    }else{
      li.innerHTML = `
        <b>FULL PAYMENT</b><br>
        Total Fees: â‚¹${p.amount}<br>
        Status: <b style="color:green">PAID</b><br>
        Date: ${p.date}
      `;
    }

    list.appendChild(li);
  });

}else{
  list.innerHTML = "<li>No payment history found</li>";
}


//Logout function
function logout(){
  localStorage.removeItem("loggedIn");
  localStorage.removeItem("currentStudent");
  window.location.href="frontend.html";
}

function showEmiPayOption(){
  if(!data || !data.paymentHistory) return;

  const dueEmis = data.paymentHistory.filter(p => p.type==="EMI" && p.status==="DUE");

  const emiBox = document.getElementById("emiPayBox");
  const emiSelect = document.getElementById("emiSelect");
 const heading = document.getElementById("payEmiHeading");


  if(dueEmis.length === 0){
    emiBox.style.display = "none";
   heading.style.display = "none"; 
    return;
  }

  emiBox.style.display = "block";
   heading.style.display = "block";  

  if(dueEmis.length > 1){
    emiSelect.style.display = "inline-block";
    emiSelect.innerHTML = '<option value="">Select EMI(s) to pay</option>';
    for(let i=1; i<=dueEmis.length; i++){
      emiSelect.innerHTML += `<option value="${i}">${i} EMI${i>1 ? "s" : ""}</option>`;
    }
  } else {
    emiSelect.style.display = "none"; // Sirf 1 EMI DUE ho â†’ dropdown hide
  }
}


function payDueEmi(){
  const upi = document.getElementById("emiUpi").value.trim();
  const emiSelect = document.getElementById("emiSelect");
  const selectedEmiCount = emiSelect.value ? parseInt(emiSelect.value) : 1;

  if(!upi){
    document.getElementById("emiPayErr").innerText = "Enter UPI ID";
    return;
  }

  // Update paymentHistory
  let students = JSON.parse(localStorage.getItem("students")) || [];
  const current = students.find(s => s.email === data.email);
  if(!current) return;

  const dueEmis = current.paymentHistory.filter(p => p.type==="EMI" && p.status==="DUE");

  for(let i=0; i<selectedEmiCount && i<dueEmis.length; i++){
    dueEmis[i].status = "PAID";
    dueEmis[i].date = new Date().toLocaleDateString();
  }

  localStorage.setItem("students", JSON.stringify(students));
localStorage.setItem("currentStudent", JSON.stringify(current));

alert("Payment Successful âœ”");
window.location.reload();

}
showEmiPayOption();

</script>
</body>
</html>
